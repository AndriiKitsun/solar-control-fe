import{b as ye,c as we,d as Ie,e as ke,f as V,g as O,h as z,i as H,j as u,k as L}from"./chunk-HS3XGNBX.js";import{a as Ce,v as Te,x as Oe,y as xe}from"./chunk-YPHPHYZO.js";import{e as Re}from"./chunk-HD72C3YN.js";import{$ as k,da as N,fa as A}from"./chunk-6SGHRMWT.js";import{B as X,Db as r,Eb as s,Fb as me,I as ee,J as te,Jb as de,K as ie,Kb as Se,Lb as T,Nc as Ee,P as ne,Tc as ge,U as oe,Ub as a,Uc as _e,V as D,Vb as d,Wa as o,Wb as S,Xa as v,Y as g,a as x,b as q,ba as re,bb as w,cc as fe,dc as ue,e as J,ec as j,f as Z,fb as pe,h as _,k as C,l as Q,la as se,ma as ae,mb as U,mc as F,n as R,nc as be,oa as ce,oc as he,pc as G,ra as le,u as y,ub as I,xc as ve}from"./chunk-FUR35FRG.js";var Ne=[{id:"acInput",title:"SENSORS.TABLE.ROW.AC_INPUT"},{id:"acOutput",title:"SENSORS.TABLE.ROW.AC_OUTPUT"},{id:"dcBattery",title:"SENSORS.TABLE.ROW.DC_BATTERY"}];var Le={url:"",deserializer:i=>JSON.parse(i.data),serializer:i=>JSON.stringify(i)},Me="WebSocketSubject.error must be called with an object with an error code, and an optional reason: { code: number, reason: string }",M=class i extends Q{constructor(e,t){if(super(),this._socket=null,e instanceof _)this.destination=t,this.source=e;else{let n=this._config=Object.assign({},Le);if(this._output=new C,typeof e=="string")n.url=e;else for(let p in e)e.hasOwnProperty(p)&&(n[p]=e[p]);if(!n.WebSocketCtor&&WebSocket)n.WebSocketCtor=WebSocket;else if(!n.WebSocketCtor)throw new Error("no WebSocket constructor can be found");this.destination=new R}}lift(e){let t=new i(this._config,this.destination);return t.operator=e,t.source=this,t}_resetState(){this._socket=null,this.source||(this.destination=new R),this._output=new C}multiplex(e,t,n){let p=this;return new _(l=>{try{p.next(e())}catch(f){l.error(f)}let c=p.subscribe({next:f=>{try{n(f)&&l.next(f)}catch(m){l.error(m)}},error:f=>l.error(f),complete:()=>l.complete()});return()=>{try{p.next(t())}catch(f){l.error(f)}c.unsubscribe()}})}_connectSocket(){let{WebSocketCtor:e,protocol:t,url:n,binaryType:p}=this._config,l=this._output,c=null;try{c=t?new e(n,t):new e(n),this._socket=c,p&&(this._socket.binaryType=p)}catch(m){l.error(m);return}let f=new J(()=>{this._socket=null,c&&c.readyState===1&&c.close()});c.onopen=m=>{let{_socket:h}=this;if(!h){c.close(),this._resetState();return}let{openObserver:Y}=this._config;Y&&Y.next(m);let B=this.destination;this.destination=Z.create(b=>{if(c.readyState===1)try{let{serializer:E}=this._config;c.send(E(b))}catch(E){this.destination.error(E)}},b=>{let{closingObserver:E}=this._config;E&&E.next(void 0),b&&b.code?c.close(b.code,b.reason):l.error(new TypeError(Me)),this._resetState()},()=>{let{closingObserver:b}=this._config;b&&b.next(void 0),c.close(),this._resetState()}),B&&B instanceof R&&f.add(B.subscribe(this.destination))},c.onerror=m=>{this._resetState(),l.error(m)},c.onclose=m=>{c===this._socket&&this._resetState();let{closeObserver:h}=this._config;h&&h.next(m),m.wasClean?l.complete():l.error(m)},c.onmessage=m=>{try{let{deserializer:h}=this._config;l.next(h(m))}catch(h){l.error(h)}}}_subscribe(e){let{source:t}=this;return t?t.subscribe(e):(this._socket||this._connectSocket(),this._output.subscribe(e),e.add(()=>{let{_socket:n}=this;this._output.observers.length===0&&(n&&(n.readyState===1||n.readyState===0)&&n.close(),this._resetState())}),e)}unsubscribe(){let{_socket:e}=this;e&&(e.readyState===1||e.readyState===0)&&e.close(),this._resetState(),super.unsubscribe()}};var W=class i{isConnected$;reconnectInterval=5e3;reconnectAttempts=10;config;reconnection$;socket$;connection$;wsMessages$;constructor(){this.wsMessages$=new C,this.config=x({closeObserver:{next:()=>{this.socket$=void 0,this.connection$.next(!1)}},openObserver:{next:()=>{this.connection$.next(!0)}}},this.getConfig()),this.isConnected$=new _(e=>{this.connection$=e}).pipe(ne(),ee()),this.isConnected$.subscribe(e=>{!this.reconnection$&&!e&&this.reconnect()}),this.connect()}on(){return this.wsMessages$.pipe(y(e=>e))}connect(){this.socket$=new M(this.config),this.socket$.subscribe({next:e=>{this.wsMessages$.next(e)},error:()=>{this.socket$||this.reconnect()}})}reconnect(){this.reconnection$=X(this.reconnectInterval).pipe(oe((e,t)=>t<this.reconnectAttempts&&!this.socket$)),this.reconnection$.subscribe({next:()=>this.connect(),complete:()=>{this.reconnection$=void 0,this.socket$||(this.wsMessages$.complete(),this.connection$.complete())}})}static \u0275fac=function(t){return new(t||i)};static \u0275prov=g({token:i,factory:i.\u0275fac})};var P=class i extends W{getConfig(){return{url:`${L.wsEndpoint}/pzems`}}static \u0275fac=(()=>{let e;return function(n){return(e||(e=ce(i)))(n||i)}})();static \u0275prov=g({token:i,factory:i.\u0275fac,providedIn:"root"})};var $=class i{constructor(e){this.http=e}resetCounters(){return this.http.delete(`${L.apiEndpoint}/pzems/counter`)}static \u0275fac=function(t){return new(t||i)(re(Ce))};static \u0275prov=g({token:i,factory:i.\u0275fac,providedIn:"root"})};var $e=i=>({time:i}),Be=()=>({"min-height":"13rem"}),De=i=>({"!bg-highlight":i});function Ue(i,e){if(i&1&&(r(0,"tr")(1,"th",9),a(2),s(),r(3,"th",9),a(4),s(),r(5,"th",9),a(6),s(),r(7,"th",9),a(8),s(),r(9,"th",9),a(10),s(),r(11,"th",9),a(12),s(),r(13,"th",9),a(14),s(),r(15,"th",9),a(16),s(),r(17,"th",9),a(18),s(),r(19,"th",9),a(20),s()()),i&2){let t=T().$implicit;o(2),S(" ",t("SENSORS.TABLE.COLUMN.NAME")," "),o(2),S(" ",t("SENSORS.TABLE.COLUMN.VOLTAGE")," "),o(2),S(" ",t("SENSORS.TABLE.COLUMN.CURRENT")," "),o(2),S(" ",t("SENSORS.TABLE.COLUMN.POWER")," "),o(2),S(" ",t("SENSORS.TABLE.COLUMN.ENERGY")," "),o(2),S(" ",t("SENSORS.TABLE.COLUMN.T1_ENERGY")," "),o(2),S(" ",t("SENSORS.TABLE.COLUMN.T2_ENERGY")," "),o(2),S(" ",t("SENSORS.TABLE.COLUMN.FREQUENCY")," "),o(2),S(" ",t("SENSORS.TABLE.COLUMN.POWER_FACTOR")," "),o(2),S(" ",t("SENSORS.TABLE.COLUMN.AVG_VOLTAGE")," ")}}function je(i,e){if(i&1&&(r(0,"tr",10)(1,"td",11),a(2),s(),r(3,"td",12),a(4),s(),r(5,"td",12),a(6),s(),r(7,"td",12),a(8),s(),r(9,"td",12),a(10),s(),r(11,"td",12),a(12),s(),r(13,"td",12),a(14),s(),r(15,"td",12),a(16),s(),r(17,"td",12),a(18),s(),r(19,"td",12),a(20),s()()),i&2){let t=e.$implicit,n=T().$implicit;I("ngClass",j(11,De,t.isEmpty)),o(2),d(n(t.title)),o(2),d(t.data.voltage),o(2),d(t.data.current),o(2),d(t.data.power),o(2),d(t.data.energy),o(2),d(t.data.t1Energy),o(2),d(t.data.t2Energy),o(2),d(t.data.frequency),o(2),d(t.data.powerFactor),o(2),d(t.data.avgVoltage)}}function Fe(i,e){if(i&1){let t=de();r(0,"div",3)(1,"div",4)(2,"div",5)(3,"span",6),a(4),F(5,"date"),s(),r(6,"p-button",7),Se("onClick",function(p){se(t);let l=T();return ae(l.openResetConfirmationModal(p))}),s()(),r(7,"p-table",8),F(8,"async"),U(9,Ue,21,10,"ng-template",null,0,G)(11,je,21,13,"ng-template",null,1,G),s()()()}if(i&2){let t=e.$implicit,n=T();o(4),d(t(n.pzemLabel,j(12,$e,he(5,7,n.createdAt,"HH:mm:ss")))),o(2),I("label",t("SENSORS.BUTTON.RESET_COUNTERS"))("disabled",n.isLoading())("loading",n.isResetProcessing()),o(),I("value",be(8,10,n.tablesRows$))("loading",n.isLoading())("tableStyle",ue(14,Be))}}var Ae=class i{constructor(e,t,n,p,l,c){this.sensorsWebSocketService=e;this.sensorsService=t;this.translocoService=n;this.messageService=p;this.confirmationService=l;this.destroyRef=c}isWsConnecting=w(!1);isTableLoading=w(!1);isLoading=ve(()=>this.isWsConnecting()||this.isTableLoading());isResetProcessing=w(!1);pzemLabel="SENSORS.PZEM_LABEL";createdAt="";tablesRows$;ngOnInit(){this.subscribeOnWsStatusChange(),this.tablesRows$=this.getTableRows()}subscribeOnWsStatusChange(){this.sensorsWebSocketService.isConnected$.pipe(Te(this.destroyRef),D(e=>{this.isWsConnecting.set(!e)})).subscribe()}getTableRows(){return this.isTableLoading.set(!0),this.sensorsWebSocketService.on().pipe(D(e=>{this.isTableLoading.set(!1),this.pzemLabel="SENSORS.PZEM_LABEL_WITH_TIME",this.createdAt=e.createdAtGmt}),y(e=>Ne.map(t=>{let n=e.pzems.find(p=>p.name===t.id);return q(x({},t),{isEmpty:!n,data:this.mapToRowData(n)})})))}mapToRowData(e){if(!e)return{};let t=e.name.startsWith("ac")?V:H;return{voltage:u(e.voltageV,t),current:u(e.currentA,O),power:u(e.powerKw,z),energy:u(e.energyKwh,O),t1Energy:u(e.t1EnergyKwh,O),t2Energy:u(e.t2EnergyKwh,O),frequency:u(e.frequencyHz,V),powerFactor:u(e.powerFactor,z),avgVoltage:u(e.avgVoltageV,H)}}openResetConfirmationModal(e){this.confirmationService.confirm({target:e.target,message:this.translocoService.translate("SENSORS.CONFIRM_DIALOG.RESET_COUNTERS.MESSAGE"),header:this.translocoService.translate("CONFIRM_DIALOG.HEADER"),icon:A.EXCLAMATION_TRIANGLE,rejectButtonProps:{label:this.translocoService.translate("BUTTON.CANCEL"),severity:"secondary",icon:A.TIMES,outlined:!0},acceptButtonProps:{label:this.translocoService.translate("BUTTON.RESET"),icon:A.CHECK,severity:"danger"},accept:()=>{this.resetCounters()}})}resetCounters(){this.isResetProcessing.set(!0),this.sensorsService.resetCounters().pipe(ie(),te(()=>{this.isResetProcessing.set(!1)})).subscribe({error:()=>{this.messageService.add({severity:"error",summary:this.translocoService.translate("TOAST.SUMMARY.ERROR"),detail:this.translocoService.translate("SENSORS.TOAST.RESET_ERROR")})}})}static \u0275fac=function(t){return new(t||i)(v(P),v($),v(Oe),v(N),v(k),v(le))};static \u0275cmp=pe({type:i,selectors:[["app-sensors"]],features:[fe([N,k])],decls:3,vars:0,consts:[["header",""],["body",""],["class","sensors",4,"transloco"],[1,"sensors"],[1,"card"],[1,"mb-4","flex","justify-between"],[1,"text-xl","font-semibold"],["variant","outlined","severity","danger","icon","pi pi-bolt",3,"onClick","label","disabled","loading"],["dataKey","id","showGridlines","","rowHover","","scrollable","","stripedRows","",3,"value","loading","tableStyle"],[1,"table__cell","table__header"],[3,"ngClass"],[1,"table__row-title"],[1,"table__cell"]],template:function(t,n){t&1&&(U(0,Fe,13,15,"div",2),me(1,"p-toast")(2,"p-confirm-dialog"))},dependencies:[we,ye,ge,Ee,xe,_e,Re,Ie,ke],styles:[".sensors[_ngcontent-%COMP%]{display:flex;flex-direction:column;height:100%}.table__cell[_ngcontent-%COMP%]{text-align:center}.table__header[_ngcontent-%COMP%]{width:10rem}.table__row-title[_ngcontent-%COMP%]{font-weight:var(--table-column-title-font-weight)}"],changeDetection:0})};export{Ae as SensorsComponent};
