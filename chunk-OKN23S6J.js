import{b as we,c as ye,d as Ie,e as Ne,f as J,g as I,h as X,i as Z,j as h,k as Pe,l as O}from"./chunk-EAHXVNW2.js";import{a as Te,v as q,x as Oe,y as Re}from"./chunk-YPHPHYZO.js";import{e as xe}from"./chunk-HD72C3YN.js";import{$ as L,da as W,fa as _}from"./chunk-6SGHRMWT.js";import{B as re,Db as o,Eb as r,Fb as Se,I as se,J as F,Jb as ue,K as G,Kb as z,Lb as f,Nc as _e,P as ae,Tc as ge,U as ce,Ub as a,Uc as Ce,V as k,Vb as d,Wa as s,Wb as S,Xa as E,Y as C,a as N,b as te,ba as le,bb as T,cc as fe,dc as he,e as ie,ec as Y,f as ne,fb as de,h as R,k as x,l as oe,la as V,ma as H,mb as M,mc as K,n as P,nc as be,oa as pe,oc as ve,pc as y,ra as me,u as A,ub as w,xc as Ee}from"./chunk-FUR35FRG.js";var Ae=[{id:"acInput",title:"SENSORS.TABLE.ROW.AC_INPUT"},{id:"acOutput",title:"SENSORS.TABLE.ROW.AC_OUTPUT"},{id:"dcBattery",title:"SENSORS.TABLE.ROW.DC_BATTERY"}];var Me={url:"",deserializer:i=>JSON.parse(i.data),serializer:i=>JSON.stringify(i)},Le="WebSocketSubject.error must be called with an object with an error code, and an optional reason: { code: number, reason: string }",B=class i extends oe{constructor(e,t){if(super(),this._socket=null,e instanceof R)this.destination=t,this.source=e;else{let n=this._config=Object.assign({},Me);if(this._output=new x,typeof e=="string")n.url=e;else for(let p in e)e.hasOwnProperty(p)&&(n[p]=e[p]);if(!n.WebSocketCtor&&WebSocket)n.WebSocketCtor=WebSocket;else if(!n.WebSocketCtor)throw new Error("no WebSocket constructor can be found");this.destination=new P}}lift(e){let t=new i(this._config,this.destination);return t.operator=e,t.source=this,t}_resetState(){this._socket=null,this.source||(this.destination=new P),this._output=new x}multiplex(e,t,n){let p=this;return new R(c=>{try{p.next(e())}catch(u){c.error(u)}let l=p.subscribe({next:u=>{try{n(u)&&c.next(u)}catch(m){c.error(m)}},error:u=>c.error(u),complete:()=>c.complete()});return()=>{try{p.next(t())}catch(u){c.error(u)}l.unsubscribe()}})}_connectSocket(){let{WebSocketCtor:e,protocol:t,url:n,binaryType:p}=this._config,c=this._output,l=null;try{l=t?new e(n,t):new e(n),this._socket=l,p&&(this._socket.binaryType=p)}catch(m){c.error(m);return}let u=new ie(()=>{this._socket=null,l&&l.readyState===1&&l.close()});l.onopen=m=>{let{_socket:v}=this;if(!v){l.close(),this._resetState();return}let{openObserver:ee}=this._config;ee&&ee.next(m);let j=this.destination;this.destination=ne.create(b=>{if(l.readyState===1)try{let{serializer:g}=this._config;l.send(g(b))}catch(g){this.destination.error(g)}},b=>{let{closingObserver:g}=this._config;g&&g.next(void 0),b&&b.code?l.close(b.code,b.reason):c.error(new TypeError(Le)),this._resetState()},()=>{let{closingObserver:b}=this._config;b&&b.next(void 0),l.close(),this._resetState()}),j&&j instanceof P&&u.add(j.subscribe(this.destination))},l.onerror=m=>{this._resetState(),c.error(m)},l.onclose=m=>{l===this._socket&&this._resetState();let{closeObserver:v}=this._config;v&&v.next(m),m.wasClean?c.complete():c.error(m)},l.onmessage=m=>{try{let{deserializer:v}=this._config;c.next(v(m))}catch(v){c.error(v)}}}_subscribe(e){let{source:t}=this;return t?t.subscribe(e):(this._socket||this._connectSocket(),this._output.subscribe(e),e.add(()=>{let{_socket:n}=this;this._output.observers.length===0&&(n&&(n.readyState===1||n.readyState===0)&&n.close(),this._resetState())}),e)}unsubscribe(){let{_socket:e}=this;e&&(e.readyState===1||e.readyState===0)&&e.close(),this._resetState(),super.unsubscribe()}};var $=class i{isConnected$;reconnectInterval=5e3;reconnectAttempts=10;config;reconnection$;socket$;connection$;wsMessages$;constructor(){this.wsMessages$=new x,this.config=N({closeObserver:{next:()=>{this.socket$=void 0,this.connection$.next(!1)}},openObserver:{next:()=>{this.connection$.next(!0)}}},this.getConfig()),this.isConnected$=new R(e=>{this.connection$=e}).pipe(ae(),se()),this.isConnected$.subscribe(e=>{!this.reconnection$&&!e&&this.reconnect()}),this.connect()}on(){return this.wsMessages$.pipe(A(e=>e))}connect(){this.socket$=new B(this.config),this.socket$.subscribe({next:e=>{this.wsMessages$.next(e)},error:()=>{this.socket$||this.reconnect()}})}reconnect(){this.reconnection$=re(this.reconnectInterval).pipe(ce((e,t)=>t<this.reconnectAttempts&&!this.socket$)),this.reconnection$.subscribe({next:()=>this.connect(),complete:()=>{this.reconnection$=void 0,this.socket$||(this.wsMessages$.complete(),this.connection$.complete())}})}static \u0275fac=function(t){return new(t||i)};static \u0275prov=C({token:i,factory:i.\u0275fac})};var U=class i extends ${getConfig(){return{url:`${O.wsEndpoint}/pzems`}}static \u0275fac=(()=>{let e;return function(n){return(e||(e=pe(i)))(n||i)}})();static \u0275prov=C({token:i,factory:i.\u0275fac,providedIn:"root"})};var D=class i{constructor(e){this.http=e}resetCounters(){return this.http.delete(`${O.apiEndpoint}/pzems/counter`)}getPowerStatus(){return this.http.get(`${O.apiEndpoint}/relays`)}switchPower(e){return this.http.put(`${O.apiEndpoint}/relays/power`,{status:e})}static \u0275fac=function(t){return new(t||i)(le(Te))};static \u0275prov=C({token:i,factory:i.\u0275fac,providedIn:"root"})};var $e=()=>({"min-height":"13rem"}),Ue=i=>({time:i}),De=i=>({"!bg-highlight":i});function je(i,e){if(i&1&&(o(0,"span",9),a(1),K(2,"date"),r()),i&2){let t=f().$implicit,n=f();s(),d(t(n.pzemLabel,Y(4,Ue,ve(2,1,n.createdAt,"HH:mm:ss"))))}}function Fe(i,e){if(i&1){let t=ue();o(0,"p-button",10),z("onClick",function(p){V(t);let c=f(2);return H(c.openSwitchPowerConfirmationModal(p))}),r(),o(1,"p-button",11),z("onClick",function(p){V(t);let c=f(2);return H(c.openResetConfirmationModal(p))}),r()}if(i&2){let t=f().$implicit,n=f();w("label",n.powerStatus()?t("SENSORS.BUTTON.POWER_OFF"):t("SENSORS.BUTTON.POWER_ON"))("severity",n.powerStatus()?"danger":"success")("disabled",n.isLoading()||n.isPowerProcessing())("loading",n.isPowerProcessing()),s(),w("label",t("SENSORS.BUTTON.RESET_COUNTERS"))("disabled",n.isLoading())("loading",n.isResetProcessing())}}function Ge(i,e){if(i&1&&(o(0,"tr")(1,"th",12),a(2),r(),o(3,"th",12),a(4),r(),o(5,"th",12),a(6),r(),o(7,"th",12),a(8),r(),o(9,"th",12),a(10),r(),o(11,"th",12),a(12),r(),o(13,"th",12),a(14),r(),o(15,"th",12),a(16),r(),o(17,"th",12),a(18),r(),o(19,"th",12),a(20),r()()),i&2){let t=f().$implicit;s(2),S(" ",t("SENSORS.TABLE.COLUMN.NAME")," "),s(2),S(" ",t("SENSORS.TABLE.COLUMN.VOLTAGE")," "),s(2),S(" ",t("SENSORS.TABLE.COLUMN.CURRENT")," "),s(2),S(" ",t("SENSORS.TABLE.COLUMN.POWER")," "),s(2),S(" ",t("SENSORS.TABLE.COLUMN.ENERGY")," "),s(2),S(" ",t("SENSORS.TABLE.COLUMN.T1_ENERGY")," "),s(2),S(" ",t("SENSORS.TABLE.COLUMN.T2_ENERGY")," "),s(2),S(" ",t("SENSORS.TABLE.COLUMN.FREQUENCY")," "),s(2),S(" ",t("SENSORS.TABLE.COLUMN.POWER_FACTOR")," "),s(2),S(" ",t("SENSORS.TABLE.COLUMN.AVG_VOLTAGE")," ")}}function Ve(i,e){if(i&1&&(o(0,"tr",13)(1,"td",14),a(2),r(),o(3,"td",15),a(4),r(),o(5,"td",15),a(6),r(),o(7,"td",15),a(8),r(),o(9,"td",15),a(10),r(),o(11,"td",15),a(12),r(),o(13,"td",15),a(14),r(),o(15,"td",15),a(16),r(),o(17,"td",15),a(18),r(),o(19,"td",15),a(20),r()()),i&2){let t=e.$implicit,n=f().$implicit;w("ngClass",Y(11,De,t.isEmpty)),s(2),d(n(t.title)),s(2),d(t.data.voltage),s(2),d(t.data.current),s(2),d(t.data.power),s(2),d(t.data.energy),s(2),d(t.data.t1Energy),s(2),d(t.data.t2Energy),s(2),d(t.data.frequency),s(2),d(t.data.powerFactor),s(2),d(t.data.avgVoltage)}}function He(i,e){if(i&1&&(o(0,"div",5)(1,"div",6)(2,"p-toolbar",7),M(3,je,3,6,"ng-template",null,0,y)(5,Fe,2,7,"ng-template",null,1,y),r(),o(7,"p-table",8),K(8,"async"),M(9,Ge,21,10,"ng-template",null,2,y)(11,Ve,21,13,"ng-template",null,3,y),r()()()),i&2){let t=f();s(7),w("value",be(8,3,t.tablesRows$))("loading",t.isLoading())("tableStyle",he(5,$e))}}var ke=class i{constructor(e,t,n,p,c,l){this.sensorsWebSocketService=e;this.sensorsService=t;this.translocoService=n;this.messageService=p;this.confirmationService=c;this.destroyRef=l}isWsConnecting=T(!1);isTableLoading=T(!1);isLoading=Ee(()=>this.isWsConnecting()||this.isTableLoading());isResetProcessing=T(!1);isPowerProcessing=T(!1);powerStatus=T(!1);pzemLabel="SENSORS.PZEM_LABEL";createdAt="";tablesRows$;ngOnInit(){this.subscribeOnWsStatusChange(),this.subscribeOnPowerChange(),this.tablesRows$=this.getTableRows()}subscribeOnWsStatusChange(){this.sensorsWebSocketService.isConnected$.pipe(q(this.destroyRef),k(e=>{this.isWsConnecting.set(!e)})).subscribe()}subscribeOnPowerChange(){this.sensorsService.getPowerStatus().pipe(q(this.destroyRef),k(e=>{this.powerStatus.set(e.status)})).subscribe()}getTableRows(){return this.isTableLoading.set(!0),this.sensorsWebSocketService.on().pipe(k(e=>{this.isTableLoading.set(!1),this.pzemLabel="SENSORS.PZEM_LABEL_WITH_TIME",this.createdAt=e.createdAtGmt}),A(e=>Ae.map(t=>{let n=e.sensors.find(p=>p.name===t.id);return te(N({},t),{isEmpty:!n,data:this.mapToRowData(n)})})))}mapToRowData(e){if(!e)return{};let t=e.name.startsWith("ac")?J:Z;return{voltage:h(e.voltage,t),current:h(e.current,I),power:h(e.power,X),energy:h(e.energy,I),t1Energy:h(e.t1Energy,I),t2Energy:h(e.t2Energy,I),frequency:h(e.frequency,J),powerFactor:h(e.powerFactor,X),avgVoltage:h(e.avgVoltage,Z)}}openResetConfirmationModal(e){this.confirmationService.confirm({target:e.target,message:this.translocoService.translate("SENSORS.CONFIRM_DIALOG.RESET_COUNTERS.MESSAGE"),header:this.translocoService.translate("CONFIRM_DIALOG.HEADER"),icon:_.EXCLAMATION_TRIANGLE,rejectButtonProps:{label:this.translocoService.translate("BUTTON.CANCEL"),severity:"secondary",icon:_.TIMES,outlined:!0},acceptButtonProps:{label:this.translocoService.translate("BUTTON.RESET"),icon:_.CHECK,severity:"danger"},accept:()=>{this.resetCounters()}})}openSwitchPowerConfirmationModal(e){this.confirmationService.confirm({target:e.target,message:this.translocoService.translate("SENSORS.CONFIRM_DIALOG.POWER.MESSAGE"),header:this.translocoService.translate("CONFIRM_DIALOG.HEADER"),icon:_.EXCLAMATION_TRIANGLE,rejectButtonProps:{label:this.translocoService.translate("BUTTON.CANCEL"),severity:"secondary",icon:_.TIMES,outlined:!0},acceptButtonProps:{label:this.translocoService.translate("BUTTON.RESET"),icon:_.CHECK,severity:"danger"},accept:()=>{this.switchPower()}})}resetCounters(){this.isResetProcessing.set(!0),this.sensorsService.resetCounters().pipe(G(),F(()=>{this.isResetProcessing.set(!1)})).subscribe({error:()=>{this.messageService.add({severity:"error",summary:this.translocoService.translate("TOAST.SUMMARY.ERROR"),detail:this.translocoService.translate("SENSORS.TOAST.RESET_ERROR")})}})}switchPower(){this.isPowerProcessing.set(!0),this.sensorsService.switchPower(!this.powerStatus()).pipe(G(),F(()=>{this.isPowerProcessing.set(!1)})).subscribe({next:e=>{this.powerStatus.set(e.status)},error:()=>{this.messageService.add({severity:"error",summary:this.translocoService.translate("TOAST.SUMMARY.ERROR"),detail:this.translocoService.translate("SENSORS.TOAST.POWER_ERROR")})}})}static \u0275fac=function(t){return new(t||i)(E(U),E(D),E(Oe),E(W),E(L),E(me))};static \u0275cmp=de({type:i,selectors:[["app-sensors"]],features:[fe([W,L])],decls:3,vars:0,consts:[["start",""],["end",""],["header",""],["body",""],["class","sensors",4,"transloco"],[1,"sensors"],[1,"card"],["styleClass","mb-4"],["dataKey","id","showGridlines","","rowHover","","scrollable","","stripedRows","",3,"value","loading","tableStyle"],[1,"text-xl","font-semibold"],["variant","outlined","icon","pi pi-power-off","styleClass","mr-2",3,"onClick","label","severity","disabled","loading"],["variant","outlined","severity","danger","icon","pi pi-bolt",3,"onClick","label","disabled","loading"],[1,"table__cell","table__header"],[3,"ngClass"],[1,"table__row-title"],[1,"table__cell"]],template:function(t,n){t&1&&(M(0,He,13,6,"div",4),Se(1,"p-toast")(2,"p-confirm-dialog"))},dependencies:[ye,we,ge,_e,Re,Ce,xe,Ie,Ne,Pe],styles:[".sensors[_ngcontent-%COMP%]{display:flex;flex-direction:column;height:100%}.table__cell[_ngcontent-%COMP%]{text-align:center}.table__header[_ngcontent-%COMP%]{width:10rem}.table__row-title[_ngcontent-%COMP%]{font-weight:var(--table-column-title-font-weight)}"],changeDetection:0})};export{ke as SensorsComponent};
